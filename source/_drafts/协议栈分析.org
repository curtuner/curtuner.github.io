#+TITLE: 协议栈分析
#+DATE: 2017-09-14
#+LAYOUT: post
#+TAGS: Network
#+CATEGORIES: Network

* 协议栈处理包的过程
** 协议栈发送包
*** 把包写入套接字
    使用 ~write()~ 向套接字描述符发送数据，之后调用文件对象的write方法，对于套接字来说，这个由 ~sock_write()~ 函数来实现，执行如下操作：
    1) 确定嵌入在文件的索引节点的套接字对象的地址
    2) 分配和初始化“消息头”，也就是msghdr数据结构，该结构存放各种控制信息
    3) 条用 ~sock_sendmsg()~ 函数，给它传递套接字对象的地址和msghdr数据结构，这个函数又执行如下操作：
       1) 调用套接字
** 协议栈接收包
   1) 数据包到达网卡后，网卡芯片将数据包通过DMA方式写入到指定的内存地址，该地址由网卡芯片分配并初始化。
   2) 网卡通过硬件中断的方式通知CPU有数据到来
** NAPI的基本思想
   混合使用中断和轮询，而不使用纯粹的事件驱动模型。内核事件驱动模型带来的问题是，中断处理开销是比较大的。NAPI是让内核处理输入队队列时，让驱动程序不去产生事件
* 
